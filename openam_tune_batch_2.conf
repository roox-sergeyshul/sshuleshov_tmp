# Configure embedded datastore
update-datastore --realm /customer --name "embedded" --datafile /opt/roox-sso-01/conf/openam-datastore.conf

# Configure authentication services
add-auth-cfg-entr --realm /customer --name external --modulename ExternalJwtLoginModule --criteria REQUISITE --options "externaljwtloginmodule-external-chain-name=websso"
add-auth-cfg-entr --realm /customer --name loginWidget --modulename ExternalJwtLoginModule --criteria REQUISITE --options "externaljwtloginmodule-external-chain-name=login-widget"
add-auth-cfg-entr --realm /customer --name uidm --modulename JwtLoginModule --criteria REQUISITE

# enable for login by msisdn http header
# add-auth-cfg-entr --realm /customer --name pad --modulename MsisdnLoginModule --criteria REQUISITE

# Requires existence of user profile in IdRepo
set-realm-svc-attrs --realm /customer -s iPlanetAMAuthService -a "iplanet-am-auth-dynamic-profile-creation=ignore"

# Configure success and failure redirect URLs
set-realm-svc-attrs --realm / -s iPlanetAMAuthService -a "iplanet-am-auth-login-success-url=/sso/console/"
set-realm-svc-attrs --realm /customer -s iPlanetAMAuthService -a "iplanet-am-auth-login-success-url=http://rumskapt155.open.ru:8080/sso/secure/lk.jsp"
set-realm-svc-attrs --realm /customer -s iPlanetAMAuthService -a "iplanet-am-auth-login-failure-url=http://rumskapt155.open.ru:8080/sso/secure/lk.jsp"

# Configure valid goto URL domains
set-realm-svc-attrs --realm /customer -s iPlanetAMAuthService -a "iplanet-am-auth-valid-goto-domains=http://rumskapt155.open.ru:8080/sso/*" "iplanet-am-auth-valid-goto-domains=http://rumskapt155.open.ru:8080/sso/*?*" "iplanet-am-auth-valid-goto-domains=http://rumskapt155.open.ru:8080/login-*"
set-realm-svc-attrs --realm /         -s iPlanetAMAuthService -a "iplanet-am-auth-valid-goto-domains=http://rumskapt155.open.ru:8080/sso/*" "iplanet-am-auth-valid-goto-domains=http://rumskapt155.open.ru:8080/sso/*?*" "iplanet-am-auth-valid-goto-domains=http://rumskapt155.open.ru:8080/login-*"

# Configure PostAuthPlugin for cookie caching
set-realm-svc-attrs --realm /customer -s iPlanetAMAuthService -a "iplanet-am-auth-post-login-process-class=com.rooxteam.sso.postauth.CachingCookiePostAuthPlugin"

# Rename iPlanetDirectoryPro cookie
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.iplanet.am.cookie.name=st"

# Set amlbcookie name for this node
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.iplanet.am.lbcookie.name=lb"

# Set amlbcookie value for this node
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.iplanet.am.lbcookie.value=sso"

# HttpOnly flag for OpenAM cookies
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.sun.identity.cookie.httponly=true"

# Secure flag for OpenAM cookies
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.iplanet.am.cookie.secure=false"

# Disable caching of application sessions
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.sun.identity.session.application.maxCacheTime=1"

# Reset amlbcookie when doing failover
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.sun.identity.session.resetLBCookie=true"

# Content length is setting up to 32k
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.iplanet.services.comm.server.pllrequest.maxContentLength=32768"

# Increase active sessions limit
update-server-cfg -s "http://rumskapt155.open.ru:15018/sso" -a "com.iplanet.am.session.maxSessions=500000"

# Configure external Token Storage
update-server-cfg -s default -a "org.forgerock.services.cts.store.location=external"
update-server-cfg -s default -a "org.forgerock.services.cts.store.root.suffix=dc=cts,dc=example,dc=com"
update-server-cfg -s default -a "org.forgerock.services.cts.store.ssl.enabled=false"
update-server-cfg -s default -a "org.forgerock.services.cts.store.directory.name=127.0.0.1"
update-server-cfg -s default -a "org.forgerock.services.cts.store.port=50390"
update-server-cfg -s default -a "org.forgerock.services.cts.store.loginid=cn=Directory Manager"
update-server-cfg -s default -a "org.forgerock.services.cts.store.password=password"
update-server-cfg -s default -a "org.forgerock.services.cts.store.max.connections=65"
update-server-cfg -s default -a "org.forgerock.services.cts.store.heartbeat=10"

# Session failover config
create-sub-cfg --servicename iPlanetAMSessionService -g SSOBalancer -b Site --priority 0 -D /opt/roox-sso-01/conf/session-failover.conf

# Configure OAuth 2.0 for customer realm
add-svc-realm --realm /customer --servicename OAuth2Provider
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-authorization-code-lifetime=30"
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-refresh-token-lifetime=1200"
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-access-token-lifetime=1200"
# set to "true" to enable OAuth 2.0 refresh-tokens
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-issue-refresh-token=false"
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-saved-consent-attribute=saved_consent"
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-jwt-token-lifetime=600"
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-keypair-name=test"
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-scope-implementation-class=com.rooxteam.sso.oauth2.RooxOauth2Scope"
set-realm-svc-attrs --realm /customer --servicename OAuth2Provider --attributevalues "forgerock-oauth2-provider-response-type-map-class=code|com.rooxteam.sso.oauth2.RooxCodeResponseType"

# Create policy for OAuth endpoint
create-policies --realm / -X /opt/roox-sso-01/conf/OAuth2ProviderPolicy.xml

# Create policies for mapping scope and auth_level
create-policies --realm / -X /opt/roox-sso-01/conf/ScopeExamplePolicy.xml
create-policies --realm / -X /opt/roox-sso-01/conf/ScopeChangePasswordPolicy.xml
create-policies --realm / -X /opt/roox-sso-01/conf/ScopeOpenapiMethod1Policy.xml
create-policies --realm / -X /opt/roox-sso-01/conf/ScopeOpenapiMethod2Policy.xml
create-policies --realm / -X /opt/roox-sso-01/conf/ScopeOpenapiMethod3Policy.xml
create-policies --realm / -X /opt/roox-sso-01/conf/DemoPolicy.xml
create-policies --realm / -X /opt/roox-sso-01/conf/DemoIdPolicy.xml
create-policies --realm / -X /opt/roox-sso-01/conf/OtpSettingsPolicies.xml
create-policies --realm / -X /opt/roox-sso-01/conf/ProductCardPolicies.xml

# Create customer policies
create-policies --realm / -X  /opt/roox-sso-01/conf/policies/all_policies.xml

# Create OAuth 2.0 client TEST_OAUTH2
create-agent --realm /customer --agenttype OAuth2Client --agentname "test_oauth2" --attributevalues "userpassword=password"
update-agent --realm /customer --agentname "test_oauth2" --attributevalues "sunIdentityServerDeviceKeyValue[0]=GROUP=LK"
update-agent --realm /customer --agentname "test_oauth2" -s --datafile /opt/roox-sso-01/conf/agent_test_oauth2.conf

# Create OAuth 2.0 client TEST_OAUTH2 type M2M
create-agent --realm /customer --agenttype OAuth2Client --agentname "test_oauth2m2m" --attributevalues "userpassword=password"
update-agent --realm /customer --agentname "test_oauth2m2m" --attributevalues "sunIdentityServerDeviceKeyValue[0]=GROUP=LK"
update-agent --realm /customer --agentname "test_oauth2m2m" -s --datafile /opt/roox-sso-01/conf/agent_test_oauth2m2m.conf

# Add searchable attributes for oauth1 token storage
add-attr-defs -s sunCoreTokenConfigService -t global -a "searchableAttributes=consumer_id"
add-attr-defs -s sunCoreTokenConfigService -t global -a "searchableAttributes=oauth.acct_ppalid"

# Create test users
# создание сделано с помощью curl в vagrant скрипте (PD-1414)
# create-identity --realm customer --idname 1234567890 --idtype User --attributevalues "userpassword=password" "login=1234567890" "telephoneNumber=1234567890" "givenname=Vasiliy" "sn=Pupkin" "middleName=Alibabaevich"
# create-identity --realm customer --idname 9876543210 --idtype User --attributevalues "userpassword=password" "login=9876543210" "telephoneNumber=9876543210" "givenname=Innokentiy" "sn=Pupkin" "middleName=Veniaminovich"

# turn on monitoring
set-attr-defs --servicename iPlanetAMMonitoringService --schematype Global --attributevalues iplanet-am-monitoring-enabled=true
set-attr-defs --servicename iPlanetAMMonitoringService --schematype Global --attributevalues iplanet-am-monitoring-snmp-enabled=true
set-attr-defs --servicename iPlanetAMMonitoringService --schematype Global --attributevalues iplanet-am-monitoring-snmp-port=15011
